# VR Integration Guide - OpenAI Realtime API

This guide explains how to integrate your VR system with the OpenAI Realtime API using ephemeral tokens.

## Overview

The VR system will communicate directly with OpenAI's Realtime API using ephemeral tokens generated by your backend. This provides:

- **Real-time voice interaction** - No round-trip delays
- **Secure authentication** - Ephemeral tokens expire in 1 minute
- **Bidirectional audio** - Send and receive audio simultaneously
- **Automatic turn detection** - AI knows when to speak vs listen

## Integration Flow

### 1. Get Ephemeral Token

Your VR system should call the backend to get an ephemeral token:

```javascript
// VR System Code
const response = await fetch('https://your-api.vercel.app/vr/realtime-token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    sessionId: 'vr-session-123',
    userId: 'user-456',
    voice: 'alloy' // optional: alloy, echo, fable, onyx, nova, shimmer
  })
});

const { ephemeralToken, connectionDetails } = await response.json();
```

### 2. Establish WebRTC Connection

Use the ephemeral token to connect to OpenAI's Realtime API:

```javascript
// VR System Code
const peerConnection = new RTCPeerConnection({
  iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
});

// Create data channel for events
const dataChannel = peerConnection.createDataChannel('oai-events');

// Connect to OpenAI Realtime API
const offer = await peerConnection.createOffer();
await peerConnection.setLocalDescription(offer);

const response = await fetch('https://api.openai.com/v1/realtime', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${ephemeralToken}`,
    'Content-Type': 'application/sdp'
  },
  body: offer.sdp
});

const answer = await response.text();
await peerConnection.setRemoteDescription({
  type: 'answer',
  sdp: answer
});
```

### 3. Handle Audio Streams

```javascript
// VR System Code
// Send audio to OpenAI
const audioStream = getUserMedia({ audio: true });
audioStream.then(stream => {
  stream.getTracks().forEach(track => {
    peerConnection.addTrack(track, stream);
  });
});

// Receive audio from OpenAI
peerConnection.ontrack = (event) => {
  const [remoteStream] = event.streams;
  const audioElement = document.createElement('audio');
  audioElement.srcObject = remoteStream;
  audioElement.play();
};

// Handle data channel events
dataChannel.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('Received from OpenAI:', data);
};
```

## API Endpoints

### POST /vr/realtime-token

Generates an ephemeral token for OpenAI Realtime API.

**Request:**
```json
{
  "sessionId": "vr-session-123",
  "userId": "user-456",
  "voice": "alloy"
}
```

**Response:**
```json
{
  "success": true,
  "ephemeralToken": "rt_ephemeral_...",
  "sessionId": "vr-session-123",
  "userId": "user-456",
  "connectionDetails": {
    "url": "https://api.openai.com/v1/realtime",
    "model": "gpt-4o-realtime-preview",
    "voice": "alloy",
    "inputAudioFormat": "pcm16",
    "outputAudioFormat": "pcm16",
    "dataChannelName": "oai-events"
  },
  "expiresAt": "2024-01-01T12:01:00.000Z",
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

### GET /vr/realtime-status

Check the status of a realtime session.

**Request:**
```
GET /vr/realtime-status?sessionId=vr-session-123&userId=user-456
```

**Response:**
```json
{
  "status": "ready",
  "sessionId": "vr-session-123",
  "userId": "user-456",
  "message": "Realtime API integration is available",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "instructions": {
    "step1": "Call POST /vr/realtime-token to get ephemeral token",
    "step2": "Use token to establish WebRTC connection to OpenAI Realtime API",
    "step3": "Send audio via WebRTC data channel 'oai-events'",
    "step4": "Receive real-time audio responses"
  }
}
```

## Security Considerations

1. **Ephemeral Tokens**: Tokens expire in 1 minute and are single-use
2. **HTTPS Only**: All communication must use secure protocols
3. **Session Validation**: Backend validates sessionId and userId
4. **Rate Limiting**: Consider implementing rate limits for token generation

## Error Handling

The API returns appropriate HTTP status codes:

- `400` - Missing required fields
- `401` - Invalid API key
- `429` - Rate limit exceeded
- `500` - Server error
- `503` - OpenAI API not configured

## Voice Options

Available voices for the Realtime API:
- `alloy` - Neutral, balanced voice
- `echo` - Warm, friendly voice
- `fable` - British accent, storytelling voice
- `onyx` - Deep, authoritative voice
- `nova` - Young, energetic voice
- `shimmer` - Soft, gentle voice

## Audio Format

- **Input**: PCM16 format (16-bit PCM)
- **Output**: PCM16 format (16-bit PCM)
- **Sample Rate**: 24kHz
- **Channels**: Mono

## Testing

You can test the integration using curl:

```bash
# Get ephemeral token
curl -X POST https://your-api.vercel.app/vr/realtime-token \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test-session",
    "userId": "test-user",
    "voice": "alloy"
  }'

# Check status
curl "https://your-api.vercel.app/vr/realtime-status?sessionId=test-session&userId=test-user"
```

## Troubleshooting

### Common Issues

1. **Token Expired**: Request a new token if the current one expires
2. **WebRTC Connection Failed**: Check network connectivity and firewall settings
3. **Audio Not Working**: Verify audio permissions and format compatibility
4. **API Key Issues**: Ensure OPENAI_API_KEY is properly configured

### Debug Mode

Enable debug logging by checking the console output for detailed error messages and connection status.
